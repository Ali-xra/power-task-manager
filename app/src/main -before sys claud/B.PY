#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os
import shutil
from datetime import datetime
import sys

def create_backup():
    """
    Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ú©Ø§Ù¾ Ú¯ÛŒØ±ÛŒ Ø§Ø² Ù¾Ø±ÙˆÚ˜Ù‡ Android Studio
    """
    
    # ØªØ§Ø±ÛŒØ® Ùˆ Ø³Ø§Ø¹Øª ÙØ¹Ù„ÛŒ
    timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
    
    # Ù¾ÙˆØ´Ù‡ ÙØ¹Ù„ÛŒ (Ø¬Ø§ÛŒÛŒ Ú©Ù‡ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø§Ø¬Ø±Ø§ Ù…ÛŒâ€ŒØ´ÙˆØ¯)
    current_dir = os.getcwd()
    project_name = os.path.basename(current_dir)
    
    # Ù¾ÙˆØ´Ù‡ Ø¨Ú©Ø§Ù¾
    backup_folder = f"backup_{project_name}_{timestamp}"
    backup_path = os.path.join(current_dir, backup_folder)
    
    # ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ùˆ Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒÛŒ Ú©Ù‡ Ù†Ø¨Ø§ÛŒØ¯ Ú©Ù¾ÛŒ Ø´ÙˆÙ†Ø¯
    ignore_items = {
        '.gradle',
        'build',
        '.idea',
        'local.properties',
        '*.iml',
        '__pycache__',
        '.git',
        'backup_*',  # Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ø¨Ú©Ø§Ù¾ Ù‚Ø¨Ù„ÛŒ
        '*.pyc',
        '.DS_Store'
    }
    
    # Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù… Ù¾Ø±ÙˆÚ˜Ù‡ Android
    important_dirs = [
        'app/src/main/java',
        'app/src/main/res',
        'app/src/main/AndroidManifest.xml',
        'app/build.gradle.kts',
        'build.gradle.kts',
        'settings.gradle.kts',
        'gradle.properties'
    ]
    
    print(f"ğŸ”„ Ø´Ø±ÙˆØ¹ Ø¨Ú©Ø§Ù¾ Ú¯ÛŒØ±ÛŒ Ø§Ø² Ù¾Ø±ÙˆÚ˜Ù‡: {project_name}")
    print(f"ğŸ“ Ù¾ÙˆØ´Ù‡ Ø¨Ú©Ø§Ù¾: {backup_folder}")
    print("-" * 50)
    
    # Ø§ÛŒØ¬Ø§Ø¯ Ù¾ÙˆØ´Ù‡ Ø¨Ú©Ø§Ù¾
    os.makedirs(backup_path, exist_ok=True)
    
    # ÙØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡ Ø³Ø§Ø®ØªØ§Ø±
    structure_file = os.path.join(backup_path, f"project_structure_{timestamp}.txt")
    
    # Ù„ÛŒØ³Øª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ù¾ÛŒ Ø´Ø¯Ù‡
    copied_files = []
    
    def should_ignore(path):
        """Ø¨Ø±Ø±Ø³ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ø¢ÛŒØ§ ÙØ§ÛŒÙ„/Ù¾ÙˆØ´Ù‡ Ø¨Ø§ÛŒØ¯ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ø´ÙˆØ¯"""
        for ignore in ignore_items:
            if ignore in path or path.endswith(ignore):
                return True
        return False
    
    def copy_with_structure(src_path, relative_path=""):
        """Ú©Ù¾ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ Ø¨Ø§ Ø­ÙØ¸ Ø³Ø§Ø®ØªØ§Ø± Ùˆ ØªØºÛŒÛŒØ± Ù†Ø§Ù…"""
        items = []
        
        for root, dirs, files in os.walk(src_path):
            # Ø­Ø°Ù Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§ÛŒ Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ø´Ø¯Ù‡
            dirs[:] = [d for d in dirs if not should_ignore(d)]
            
            rel_dir = os.path.relpath(root, current_dir)
            
            if should_ignore(rel_dir):
                continue
            
            # Ú©Ù¾ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§
            for file in files:
                if should_ignore(file):
                    continue
                    
                src_file = os.path.join(root, file)
                rel_path = os.path.relpath(src_file, current_dir)
                
                # ØªØ¨Ø¯ÛŒÙ„ Ù…Ø³ÛŒØ± Ø¨Ù‡ Ù†Ø§Ù… ÙØ§ÛŒÙ„ (Ø¬Ø§ÛŒÚ¯Ø²ÛŒÙ†ÛŒ / Ø¨Ø§ _)
                safe_filename = rel_path.replace(os.sep, '_').replace('/', '_')
                dest_file = os.path.join(backup_path, safe_filename)
                
                try:
                    shutil.copy2(src_file, dest_file)
                    copied_files.append((rel_path, safe_filename))
                    items.append(rel_path)
                    print(f"âœ… Ú©Ù¾ÛŒ Ø´Ø¯: {rel_path}")
                except Exception as e:
                    print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ú©Ù¾ÛŒ {rel_path}: {e}")
        
        return items
    
    def generate_tree_structure(path, prefix="", is_last=True):
        """Ø§ÛŒØ¬Ø§Ø¯ Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø®ØªÛŒ Ø§Ø² Ù¾Ø±ÙˆÚ˜Ù‡"""
        lines = []
        
        if os.path.isfile(path):
            return []
        
        items = []
        try:
            items = sorted(os.listdir(path))
            items = [item for item in items if not should_ignore(item)]
        except PermissionError:
            return []
        
        for i, item in enumerate(items):
            item_path = os.path.join(path, item)
            is_last_item = (i == len(items) - 1)
            
            # Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù…Ø§Ø¯ Ù…Ù†Ø§Ø³Ø¨
            if is_last_item:
                connector = "â””â”€â”€ "
                extension = "    "
            else:
                connector = "â”œâ”€â”€ "
                extension = "â”‚   "
            
            # Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¢ÛŒØªÙ… Ø¨Ù‡ Ø³Ø§Ø®ØªØ§Ø±
            if os.path.isdir(item_path):
                lines.append(f"{prefix}{connector}ğŸ“ {item}/")
                # Ø¨Ø§Ø²Ú¯Ø´ØªÛŒ Ø¨Ø±Ø§ÛŒ Ø²ÛŒØ±Ù¾ÙˆØ´Ù‡â€ŒÙ‡Ø§
                sub_lines = generate_tree_structure(
                    item_path, 
                    prefix + extension, 
                    is_last_item
                )
                lines.extend(sub_lines)
            else:
                # ØªØ¹ÛŒÛŒÙ† Ø¢ÛŒÚ©ÙˆÙ† Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ ÙØ§ÛŒÙ„
                if item.endswith('.kt'):
                    icon = "ğŸ¯"  # Kotlin
                elif item.endswith('.java'):
                    icon = "â˜•"  # Java
                elif item.endswith('.xml'):
                    icon = "ğŸ“„"  # XML
                elif item.endswith('.gradle') or item.endswith('.kts'):
                    icon = "ğŸ”§"  # Gradle
                else:
                    icon = "ğŸ“„"
                lines.append(f"{prefix}{connector}{icon} {item}")
        
        return lines
    
    # Ú©Ù¾ÛŒ Ú©Ù„ Ù¾Ø±ÙˆÚ˜Ù‡
    print("\nğŸ“‚ Ø¯Ø± Ø­Ø§Ù„ Ú©Ù¾ÛŒ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§...")
    all_files = copy_with_structure(current_dir)
    
    # Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ Ø³Ø§Ø®ØªØ§Ø±
    print("\nğŸ“ Ø¯Ø± Ø­Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ Ø³Ø§Ø®ØªØ§Ø± Ù¾Ø±ÙˆÚ˜Ù‡...")
    with open(structure_file, 'w', encoding='utf-8') as f:
        f.write("=" * 60 + "\n")
        f.write(f"ğŸš€ Ø³Ø§Ø®ØªØ§Ø± Ù¾Ø±ÙˆÚ˜Ù‡: {project_name}\n")
        f.write(f"ğŸ“… ØªØ§Ø±ÛŒØ® Ø¨Ú©Ø§Ù¾: {datetime.now().strftime('%Y/%m/%d %H:%M:%S')}\n")
        f.write(f"ğŸ“ ØªØ¹Ø¯Ø§Ø¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ù¾ÛŒ Ø´Ø¯Ù‡: {len(copied_files)}\n")
        f.write("=" * 60 + "\n\n")
        
        # Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø®ØªÛŒ
        f.write("ğŸŒ³ Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø®ØªÛŒ Ù¾Ø±ÙˆÚ˜Ù‡:\n")
        f.write("-" * 40 + "\n")
        tree_lines = generate_tree_structure(current_dir)
        for line in tree_lines:
            f.write(line + "\n")
        
        # Ù„ÛŒØ³Øª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ù¾ÛŒ Ø´Ø¯Ù‡
        f.write("\n" + "=" * 60 + "\n")
        f.write("ğŸ“‹ Ù„ÛŒØ³Øª ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ú©Ù¾ÛŒ Ø´Ø¯Ù‡:\n")
        f.write("-" * 40 + "\n")
        for original, backup in copied_files:
            f.write(f"âœ“ {original}\n")
            f.write(f"  â†’ {backup}\n\n")
    
    # Ø§ÛŒØ¬Ø§Ø¯ ÙØ§ÛŒÙ„ README
    readme_file = os.path.join(backup_path, "README.txt")
    with open(readme_file, 'w', encoding='utf-8') as f:
        f.write(f"""
=====================================
Ù¾Ø±ÙˆÚ˜Ù‡: {project_name}
ØªØ§Ø±ÛŒØ® Ø¨Ú©Ø§Ù¾: {datetime.now().strftime('%Y/%m/%d %H:%M:%S')}
=====================================

ğŸ“± ØªÙˆØ¶ÛŒØ­Ø§Øª Ù¾Ø±ÙˆÚ˜Ù‡:
-----------------
Ø§ÛŒÙ† ÛŒÚ© Ø§Ù¾Ù„ÛŒÚ©ÛŒØ´Ù† Ø¢Ù„Ø§Ø±Ù… Ù‡ÙˆØ´Ù…Ù†Ø¯ Ø¨Ø±Ø§ÛŒ Ø§Ù†Ø¯Ø±ÙˆÛŒØ¯ Ø§Ø³Øª Ú©Ù‡ Ø¯Ø§Ø±Ø§ÛŒ ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ± Ù…ÛŒâ€ŒØ¨Ø§Ø´Ø¯:

âœ… ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§ÛŒ Ø§ØµÙ„ÛŒ:
â€¢ Ø²Ù†Ú¯ ØµØ¨Ø­Ú¯Ø§Ù‡ÛŒ Ø¨Ø§ Ú†Ø§Ù„Ø´ ØªØ§ÛŒÙ¾ Ø¬Ù…Ù„Ø§Øª Ø§Ù†Ú¯ÛŒØ²Ø´ÛŒ
â€¢ ÛŒØ§Ø¯Ø¢ÙˆØ± Ø´Ø¨Ø§Ù†Ù‡ Ø¨Ø±Ø§ÛŒ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø±ÙˆØ²Ø§Ù†Ù‡ (Ø§Ù…ØªÛŒØ§Ø² 1 ØªØ§ 10)
â€¢ Ù…Ø¯ÛŒØ±ÛŒØª Ø¬Ù…Ù„Ø§Øª Ø§Ù†Ú¯ÛŒØ²Ø´ÛŒ Ø¯Ù„Ø®ÙˆØ§Ù‡
â€¢ ØµÙØ­Ù‡ Ø¢Ù…Ø§Ø± Ùˆ Ú¯Ø²Ø§Ø±Ø´ Ø¹Ù…Ù„Ú©Ø±Ø¯

ğŸ”§ ØªÚ©Ù†ÙˆÙ„ÙˆÚ˜ÛŒâ€ŒÙ‡Ø§:
â€¢ Ø²Ø¨Ø§Ù†: Kotlin
â€¢ IDE: Android Studio
â€¢ Min SDK: 21
â€¢ Target SDK: 34

ğŸ“‚ Ø³Ø§Ø®ØªØ§Ø± Ù¾Ø±ÙˆÚ˜Ù‡:
â€¢ app/src/main/java/com/Alixra/power/ - Ú©Ø¯Ù‡Ø§ÛŒ Kotlin
  - MainActivity.kt - ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ
  - ui/AlarmActivity.kt - ØµÙØ­Ù‡ Ú†Ø§Ù„Ø´ Ø¢Ù„Ø§Ø±Ù…
  - ui/EveningActivity.kt - ØµÙØ­Ù‡ Ø§Ø±Ø²ÛŒØ§Ø¨ÛŒ Ø´Ø¨Ø§Ù†Ù‡
  - service/AlarmService.kt - Ø³Ø±ÙˆÛŒØ³ Ù¾Ø®Ø´ ØµØ¯Ø§
  - receiver/AlarmReceiver.kt - Ø¯Ø±ÛŒØ§ÙØªâ€ŒÚ©Ù†Ù†Ø¯Ù‡ Ø¢Ù„Ø§Ø±Ù…
  - data/PreferencesManager.kt - Ù…Ø¯ÛŒØ±ÛŒØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
  
â€¢ app/src/main/res/ - Ù…Ù†Ø§Ø¨Ø¹
  - layout/ - ÙØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ XML Ø±Ø§Ø¨Ø· Ú©Ø§Ø±Ø¨Ø±ÛŒ
  - drawable/ - ØªØµØ§ÙˆÛŒØ± Ùˆ Ù¾Ø³â€ŒØ²Ù…ÛŒÙ†Ù‡â€ŒÙ‡Ø§
  - values/ - Ø±Ù†Ú¯â€ŒÙ‡Ø§ØŒ Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ Ùˆ Ø±Ø´ØªÙ‡â€ŒÙ‡Ø§

ğŸ“± Ù†Ø­ÙˆÙ‡ Ø§Ø¬Ø±Ø§:
1. Android Studio Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯
2. Open an Existing Project
3. Ù¾ÙˆØ´Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯
4. Sync Ùˆ Build Ú©Ù†ÛŒØ¯
5. Ø±ÙˆÛŒ Ø¯Ø³ØªÚ¯Ø§Ù‡ ÛŒØ§ Ø§Ù…ÙˆÙ„Ø§ØªÙˆØ± Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯

âš ï¸ Ù†Ú©Ø§Øª Ù…Ù‡Ù…:
â€¢ Ø­Ø¯Ø§Ù‚Ù„ Android 5.0 (API 21) Ù…ÙˆØ±Ø¯ Ù†ÛŒØ§Ø² Ø§Ø³Øª
â€¢ Ù…Ø¬ÙˆØ²Ù‡Ø§ÛŒ Ù„Ø§Ø²Ù… Ø¨Ø§ÛŒØ¯ ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø± ØªØ§ÛŒÛŒØ¯ Ø´ÙˆÙ†Ø¯
â€¢ Ø¨Ø±Ø§ÛŒ Ø¢Ù„Ø§Ø±Ù… Ø¯Ù‚ÛŒÙ‚ØŒ Ø¨Ù‡ÛŒÙ†Ù‡â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø§ØªØ±ÛŒ Ø±Ø§ ØºÛŒØ±ÙØ¹Ø§Ù„ Ú©Ù†ÛŒØ¯

=====================================
        """)
    
    print("\n" + "=" * 50)
    print(f"âœ… Ø¨Ú©Ø§Ù¾ Ú¯ÛŒØ±ÛŒ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯!")
    print(f"ğŸ“ Ù…Ø­Ù„ Ø°Ø®ÛŒØ±Ù‡: {backup_path}")
    print(f"ğŸ“Š ØªØ¹Ø¯Ø§Ø¯ ÙØ§ÛŒÙ„â€ŒÙ‡Ø§: {len(copied_files)}")
    print(f"ğŸ“„ ÙØ§ÛŒÙ„ Ø³Ø§Ø®ØªØ§Ø±: {os.path.basename(structure_file)}")
    print("=" * 50)

if __name__ == "__main__":
    try:
        create_backup()
        input("\nâœ¨ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ Enter Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯...")
    except KeyboardInterrupt:
        print("\n\nâŒ Ø¹Ù…Ù„ÛŒØ§Øª Ù„ØºÙˆ Ø´Ø¯.")
        sys.exit(1)
    except Exception as e:
        print(f"\nâŒ Ø®Ø·Ø§: {e}")
        input("\nØ¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ Enter Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯...")
        sys.exit(1)